---
- name: Install packages
  apt:
    state: latest
    name:
      - dbus-user-session
      - crun
      - uidmap
      - slirp4netns
      - podman

- name: Install systemd files for podman-prune
  template: src={{ item }} dest=/etc/systemd/system/
  with_items:
    - podman-prune.service
    - podman-prune.timer

- name: Start podman-prune.timer
  systemd:
    name: podman-prune.timer
    state: started
    enabled: true
    daemon_reload: true

- name: Login to container registry and create /etc/containers/auth.json
  containers.podman.podman_login:
    username: "{{ item.username }}"
    password: '{{ item.password }}'
    registry: "{{ item.registry }}"
    authfile: "{{ podman_auth_file }}"
  with_items: "{{ podman_authorized_repos }}"
  when: podman_authorized_repos is defined
  no_log: true

- name: Change permissions of auth file
  ansible.builtin.file:
    path: "{{ podman_auth_file }}"
    state: file
    mode: '0755'
  when: podman_authorized_repos is defined
